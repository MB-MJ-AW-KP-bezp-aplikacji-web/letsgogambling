{% extends "base.html" %}

{% block title %}Slots{% endblock %}

{% block extra_head %}
<style>
    .slot-cell {
        width: 52px;
        height: 52px;
        font-size: 1.8rem;
        text-align: center;
        vertical-align: middle;
        background: rgba(17, 24, 39, 0.8);
        border: 2px solid #374151;
        transition: all 0.3s ease;
        user-select: none;
    }
    .slot-cell.strike {
        background: rgba(57, 255, 20, 0.2);
        border-color: #39ff14;
        box-shadow: 0 0 10px #39ff14;
    }
    .slot-machine {
        border: 3px solid #9333ea;
        box-shadow: 0 0 20px rgba(147, 51, 234, 0.3);
        border-radius: 0.75rem;
        padding: 0.5rem;
        background: linear-gradient(135deg, rgba(17, 24, 39, 0.9) 0%, rgba(31, 41, 55, 0.9) 100%);
        display: inline-block;
    }
    .slot-machine.winner {
        border-color: #39ff14;
        box-shadow: 0 0 30px rgba(57, 255, 20, 0.5);
    }
    .slot-machine.loser {
        opacity: 0.6;
    }
    .machines-container {
        display: flex;
        flex-wrap: nowrap;
        gap: 16px;
        justify-content: center;
        margin-bottom: 1rem;
        padding: 10px 0;
    }
    .machine-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }
    .machine-result {
        font-family: 'Orbitron', sans-serif;
        font-size: 14px;
        min-height: 20px;
    }
    .machine-result.win {
        color: #39ff14;
        text-shadow: 0 0 10px #39ff14;
    }
    .machine-result.lose {
        color: #6b7280;
    }
    @keyframes spin {
        0% { transform: rotateX(0deg); }
        100% { transform: rotateX(360deg); }
    }
    .spinning .slot-cell {
        animation: spin 0.1s linear infinite;
    }
    .quick-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: center;
    }
    .quick-btn {
        flex: 0 1 auto;
        min-width: 44px;
        padding: 8px 10px;
        font-size: 11px;
        font-weight: bold;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-family: 'Orbitron', sans-serif;
    }
    .quick-btn.add {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        color: white;
    }
    .quick-btn.add:hover {
        box-shadow: 0 0 15px rgba(34, 197, 94, 0.5);
        transform: translateY(-1px);
    }
    .quick-btn.modify {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
    }
    .quick-btn.modify:hover {
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        transform: translateY(-1px);
    }
    .quick-btn.clear {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }
    .quick-btn.clear:hover {
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
        transform: translateY(-1px);
    }
    .quick-btn.allin {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }
    .quick-btn.allin:hover {
        box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
        transform: translateY(-1px);
    }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    input[type=number] {
        -moz-appearance: textfield;
    }
    #spin-btn:disabled {
        background: #374151;
        cursor: not-allowed;
        box-shadow: none;
        color: #6b7280;
    }
    .machine-count-selector {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin-bottom: 16px;
    }
    .machine-count-btn {
        width: 40px;
        height: 40px;
        border: 2px solid #374151;
        border-radius: 8px;
        background: rgba(17, 24, 39, 0.8);
        color: #9ca3af;
        font-family: 'Orbitron', sans-serif;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
    }
    .machine-count-btn:hover {
        border-color: #9333ea;
        color: #e5e7eb;
    }
    .machine-count-btn.selected {
        border-color: #9333ea;
        background: rgba(147, 51, 234, 0.3);
        color: #e5e7eb;
        box-shadow: 0 0 15px rgba(147, 51, 234, 0.4);
    }
    .total-bet-display {
        text-align: center;
        color: #9ca3af;
        font-size: 14px;
    }
    .total-bet-display span {
        color: #ffd700;
        font-family: 'Orbitron', sans-serif;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4">
    <h1 class="font-casino text-4xl text-center text-neon-gold text-glow-gold mb-8 tracking-wider">SLOTS</h1>

    <div class="card-casino rounded-2xl p-6 mb-8">
        <div class="flex justify-between items-center mb-6">
            <span class="text-gray-400"></span>
            <span class="font-casino text-2xl text-neon-gold">$<span id="balance">0</span></span>
        </div>

        <div class="text-center text-gray-400 text-sm mb-2">Number of Machines</div>
        <div class="machine-count-selector">
            <button class="machine-count-btn selected" data-count="1">1</button>
            <button class="machine-count-btn" data-count="2">2</button>
            <button class="machine-count-btn" data-count="3">3</button>
            <button class="machine-count-btn" data-count="4">4</button>
            <button class="machine-count-btn" data-count="5">5</button>
        </div>

        <div id="machines-container" class="machines-container">
            <!-- Machines will be generated by JS -->
        </div>

        <div id="message" class="text-center text-xl font-casino"></div>

        <div class="flex flex-col items-center gap-3">
            <div class="quick-buttons">
                <button class="quick-btn clear" onclick="setBetAmount(0)">CLR</button>
                <button class="quick-btn add" onclick="addToBet(10)">+10</button>
                <button class="quick-btn add" onclick="addToBet(100)">+100</button>
                <button class="quick-btn add" onclick="addToBet(1000)">+1K</button>
                <button class="quick-btn add" onclick="addToBet(10000)">+10K</button>
                <button class="quick-btn modify" onclick="multiplyBet(0.5)">1/2</button>
                <button class="quick-btn modify" onclick="multiplyBet(2)">2X</button>
                <button class="quick-btn allin" onclick="allIn()">MAX</button>
            </div>
            <div class="total-bet-display">Total bet: <span id="total-bet">$0</span></div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <label class="text-gray-400">Bet each:</label>
                    <input id="bet-amount" type="number" min="1" step="1" value="1"
                           class="input-casino w-24 px-3 py-2 rounded-lg text-center text-xl text-gray-100">
                </div>
                <button id="spin-btn" class="btn-casino px-8 py-3 rounded-lg font-casino text-xl text-white tracking-wider">
                    SPIN
                </button>
            </div>
        </div>
    </div>

    <div class="text-center text-gray-500 text-sm">
        <p>Match 3 in a row or diagonal to win!</p>
    </div>
</div>

<script>
function getCookie(name) {
    return document.cookie.split('; ')
        .find(row => row.startsWith(name + '='))
        ?.split('=')[1];
}
const csrftoken = getCookie('csrftoken');

const balanceEl = document.getElementById("balance");
const messageEl = document.getElementById("message");
const machinesContainer = document.getElementById("machines-container");
const spinBtn = document.getElementById("spin-btn");
const betInput = document.getElementById("bet-amount");
const totalBetEl = document.getElementById("total-bet");
let isSpinning = false;
let machineCount = 1;

function createMachineHTML(index) {
    return `
        <div class="machine-wrapper">
            <div class="slot-machine" id="slot-machine-${index}">
                <table class="border-separate border-spacing-1">
                    <tbody>
                        <tr>
                            <td class="slot-cell rounded-lg">❓</td>
                            <td class="slot-cell rounded-lg">❓</td>
                            <td class="slot-cell rounded-lg">❓</td>
                        </tr>
                        <tr>
                            <td class="slot-cell rounded-lg">❓</td>
                            <td class="slot-cell rounded-lg">❓</td>
                            <td class="slot-cell rounded-lg">❓</td>
                        </tr>
                        <tr>
                            <td class="slot-cell rounded-lg">❓</td>
                            <td class="slot-cell rounded-lg">❓</td>
                            <td class="slot-cell rounded-lg">❓</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="machine-result" id="result-${index}"></div>
        </div>
    `;
}

function renderMachines() {
    machinesContainer.innerHTML = '';
    for (let i = 0; i < machineCount; i++) {
        machinesContainer.innerHTML += createMachineHTML(i);
    }
    updateTotalBet();
}

function updateTotalBet() {
    const bet = Number(betInput.value) || 0;
    totalBetEl.textContent = `$${formatMoney(bet * machineCount)}`;
}

// Machine count selector
document.querySelectorAll('.machine-count-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        if (isSpinning) return;
        document.querySelectorAll('.machine-count-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        machineCount = parseInt(btn.dataset.count);
        renderMachines();
    });
});

// Restore last bet from localStorage
const savedBet = localStorage.getItem('slots_bet');
if (savedBet) {
    betInput.value = savedBet;
}

// Save bet amount when it changes and ensure integer
betInput.addEventListener('change', () => {
    const val = parseFloat(betInput.value) || 0;
    betInput.value = val > 0 ? Math.floor(val) : '';
    localStorage.setItem('slots_bet', betInput.value);
    updateTotalBet();
});

betInput.addEventListener('input', updateTotalBet);

function formatMoney(amount) {
    // Format number with commas: 16986566 -> 16,986,566
    return Math.floor(amount).toLocaleString('en-US');
}

function getCurrentBalance() {
    // Remove commas before parsing: "16,986,566" -> 16986566
    const balanceText = balanceEl.textContent.replace(/,/g, '');
    return parseFloat(balanceText) || 0;
}

function setBetAmount(amount) {
    betInput.value = amount > 0 ? Math.floor(amount) : '';
    localStorage.setItem('slots_bet', betInput.value);
    updateTotalBet();
}

function addToBet(amount) {
    const current = parseFloat(betInput.value) || 0;
    setBetAmount(current + amount);
}

function multiplyBet(multiplier) {
    const current = parseFloat(betInput.value) || 0;
    setBetAmount(Math.floor(current * multiplier));
}

function allIn() {
    setBetAmount(Math.floor(getCurrentBalance() / machineCount));
}

fetch("/api/balance/")
  .then(res => res.json())
  .then(data => {
    balanceEl.textContent = formatMoney(data.balance);
  });

// Initialize machines
renderMachines();

spinBtn.addEventListener("click", async () => {
    if (isSpinning) return;

    const bet = Number(betInput.value);
    localStorage.setItem('slots_bet', betInput.value);
    const totalBet = bet * machineCount;

    if (!Number.isFinite(bet) || bet < 1) {
        messageEl.textContent = "Invalid bet amount.";
        messageEl.className = "text-center text-xl font-casino mb-4 h-8 text-red-400";
        return;
    }

    if (totalBet > getCurrentBalance()) {
        messageEl.textContent = "TOO BROKE!";
        messageEl.className = "text-center text-xl font-casino mb-4 h-8 text-red-400";
        return;
    }

    isSpinning = true;
    spinBtn.disabled = true;
    messageEl.textContent = "";

    // Start spinning all machines
    for (let i = 0; i < machineCount; i++) {
        const machine = document.getElementById(`slot-machine-${i}`);
        machine.classList.add("spinning");
        machine.classList.remove("winner", "loser");
        document.getElementById(`result-${i}`).textContent = "";
        document.getElementById(`result-${i}`).className = "machine-result";
    }

    try {
        const response = await fetch("/api/spin/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify({ bet: bet, count: machineCount })
        });
        const data = await response.json();

        setTimeout(() => {
            if (data.error) {
                for (let i = 0; i < machineCount; i++) {
                    const machine = document.getElementById(`slot-machine-${i}`);
                    machine.classList.remove("spinning");
                }
                messageEl.textContent = data.error;
                messageEl.className = "text-center text-xl font-casino mb-4 h-8 text-red-400";
                isSpinning = false;
                spinBtn.disabled = false;
                return;
            }

            data.results.forEach((result, i) => {
                const machine = document.getElementById(`slot-machine-${i}`);
                const resultEl = document.getElementById(`result-${i}`);
                machine.classList.remove("spinning");

                const rows = machine.querySelectorAll("tr");
                result.machine.forEach((row, ri) => {
                    row.forEach((sym, ci) => {
                        const cell = rows[ri].children[ci];
                        cell.textContent = sym;
                        if (result.strikes[ri][ci]) {
                            cell.classList.add("strike");
                        } else {
                            cell.classList.remove("strike");
                        }
                    });
                });

                if (result.win > 0) {
                    machine.classList.add("winner");
                    resultEl.textContent = `+$${formatMoney(result.win)}`;
                    resultEl.className = "machine-result win";
                } else {
                    machine.classList.add("loser");
                    resultEl.textContent = "NO WIN";
                    resultEl.className = "machine-result lose";
                }
            });

            balanceEl.textContent = formatMoney(data.balance);

            if (data.total_win > 0) {
                messageEl.textContent = `TOTAL WIN: +$${formatMoney(data.total_win)}`;
                messageEl.className = "text-center text-xl font-casino mb-4 h-8 text-neon-green text-glow-green";
            } else {
                messageEl.textContent = "NO WINS";
                messageEl.className = "text-center text-xl font-casino mb-4 h-8 text-gray-500";
            }

            isSpinning = false;
            spinBtn.disabled = false;
        }, 500);

    } catch (err) {
        for (let i = 0; i < machineCount; i++) {
            document.getElementById(`slot-machine-${i}`).classList.remove("spinning");
        }
        isSpinning = false;
        spinBtn.disabled = false;
        messageEl.textContent = "Server Error";
        messageEl.className = "text-center text-xl font-casino mb-4 h-8 text-red-400";
    }
});
</script>

{% endblock %}
