{% extends "base.html" %}

{% block title %}Slots{% endblock %}

{% block extra_head %}
<style>
    .slot-cell {
        width: 80px;
        height: 80px;
        font-size: 3rem;
        text-align: center;
        vertical-align: middle;
        background: rgba(17, 24, 39, 0.8);
        border: 2px solid #374151;
        transition: all 0.3s ease;
    }
    .slot-cell.strike {
        text-decoration: line-through;
        background: rgba(57, 255, 20, 0.2);
        border-color: #39ff14;
        box-shadow: 0 0 10px #39ff14;
    }
    .slot-machine {
        border: 3px solid #9333ea;
        box-shadow: 0 0 30px rgba(147, 51, 234, 0.3);
        border-radius: 1rem;
        padding: 1rem;
        background: linear-gradient(135deg, rgba(17, 24, 39, 0.9) 0%, rgba(31, 41, 55, 0.9) 100%);
    }
    @keyframes spin {
        0% { transform: rotateX(0deg); }
        100% { transform: rotateX(360deg); }
    }
    .spinning .slot-cell {
        animation: spin 0.1s linear infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <h1 class="font-casino text-4xl text-center text-neon-gold text-glow-gold mb-8 tracking-wider">SLOTS</h1>

    <div class="card-casino rounded-2xl p-6 mb-8">
        <div class="flex justify-between items-center mb-6">
            <span class="text-gray-400">Your Balance</span>
            <span class="font-casino text-2xl text-neon-gold">$<span id="balance">0</span></span>
        </div>

        <div id="slot-machine" class="slot-machine mx-auto w-fit mb-6">
            <table class="border-separate border-spacing-2">
                <tbody>
                    {% for _ in "123" %}
                    <tr>
                        {% for _ in "123" %}
                        <td class="slot-cell rounded-lg">‚ùì</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="message" class="text-center text-xl font-casino mb-6 h-8"></div>

        <div class="flex items-center justify-center gap-4">
            <div class="flex items-center gap-2">
                <label class="text-gray-400">Bet:</label>
                <input id="bet-amount" type="number" min="1" value="1"
                       class="input-casino w-24 px-3 py-2 rounded-lg text-center text-xl text-gray-100">
            </div>
            <button id="spin-btn" class="btn-casino px-8 py-3 rounded-lg font-casino text-xl text-white tracking-wider">
                SPIN
            </button>
        </div>
    </div>

    <div class="text-center text-gray-500 text-sm">
        <p>Match 3 in a row, column, or diagonal to win!</p>
    </div>
</div>

<script>
function getCookie(name) {
    return document.cookie.split('; ')
        .find(row => row.startsWith(name + '='))
        ?.split('=')[1];
}
const csrftoken = getCookie('csrftoken');

const balanceEl = document.getElementById("balance");
const messageEl = document.getElementById("message");
const slotMachine = document.getElementById("slot-machine");
const spinBtn = document.getElementById("spin-btn");

fetch("/api/balance/")
  .then(res => res.json())
  .then(data => {
    balanceEl.textContent = data.balance;
  });

spinBtn.addEventListener("click", () => {
    const betInput = document.getElementById("bet-amount").value;
    const bet = Number(betInput);

    if (!Number.isFinite(bet) || bet < 1) {
        messageEl.textContent = "Invalid bet amount.";
        messageEl.className = "text-center text-xl font-casino mb-6 h-8 text-red-400";
        return;
    }

    spinBtn.disabled = true;
    slotMachine.classList.add("spinning");

    fetch("/api/spin/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({ bet: bet })
    })
    .then(res => res.json())
    .then(data => {
        setTimeout(() => {
            slotMachine.classList.remove("spinning");
            spinBtn.disabled = false;

            if (data.error) {
                messageEl.textContent = data.error;
                messageEl.className = "text-center text-xl font-casino mb-6 h-8 text-red-400";
                return;
            }
            if (!data.machine) {
                messageEl.textContent = "TOO BROKE!";
                messageEl.className = "text-center text-xl font-casino mb-6 h-8 text-red-400";
                return;
            }

            const rows = document.querySelectorAll("#slot-machine tr");
            data.machine.forEach((row, i) => {
                row.forEach((sym, j) => {
                    const cell = rows[i].children[j];
                    cell.textContent = sym;
                    if (data.strikes[i][j]) {
                        cell.classList.add("strike");
                    } else {
                        cell.classList.remove("strike");
                    }
                });
            });

            balanceEl.textContent = data.balance;

            if (data.win > 0) {
                messageEl.textContent = `WINNER! +$${data.win}`;
                messageEl.className = "text-center text-xl font-casino mb-6 h-8 text-neon-green text-glow-green";
            } else {
                messageEl.textContent = "NO WIN";
                messageEl.className = "text-center text-xl font-casino mb-6 h-8 text-gray-500";
            }
        }, 500);
    })
    .catch(err => {
        slotMachine.classList.remove("spinning");
        spinBtn.disabled = false;
        messageEl.textContent = "Server Error";
        messageEl.className = "text-center text-xl font-casino mb-6 h-8 text-red-400";
    });
});
</script>

{% endblock %}
