{% extends "base.html" %}

{% block title %}Slots{% endblock %}

{% block content %}
<h1>SLOTS</h1>

<p>BAL: <span id="balance">0</span></p>

<div id="slot-machine">
  <h1>
  <table>
    <tbody>
      {% for _ in "123" %}
      <tr>
        {% for _ in "123" %}
          <td class="slot-symbol">‚ùì</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</h1>
</div>

<hr>

<label>Bet:</label>
<input id="bet-amount" type="number" min="1" value="1">
<button id="spin-btn">SPIN</button>

<p id="message"></p>

<script>
function getCookie(name) {
    return document.cookie.split('; ')
        .find(row => row.startsWith(name + '='))
        ?.split('=')[1];
}
const csrftoken = getCookie('csrftoken');

const balanceEl = document.getElementById("balance");
const messageEl = document.getElementById("message");
const symbolsEl = document.querySelectorAll(".slot-symbol");
const spinBtn = document.getElementById("spin-btn");

fetch("/api/balance/")
  .then(res => res.json())
  .then(data => {
    balanceEl.textContent = data.balance;
  });

spinBtn.addEventListener("click", () => {
    const betInput = document.getElementById("bet-amount").value;
    const bet = Number(betInput);

    if (!Number.isFinite(bet) || bet < 1) {
        messageEl.textContent = "Invalid bet amount.";
        return;
    }

    fetch("/api/spin/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({ bet: bet })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            messageEl.textContent = data.error;
            return;
        }
        if (!data.machine) {
            messageEl.textContent = "TOO BROKE!";
            return;
        }

        const rows = document.querySelectorAll("#slot-machine tr");
        data.machine.forEach((row, i) => {
            row.forEach((sym, j) => {
                const cell = rows[i].children[j];
                cell.textContent = sym;
                cell.style.textDecoration = data.strikes[i][j] ? "line-through" : "none";
            });
        });

        balanceEl.textContent = data.balance;

        if (data.win > 0) {
            messageEl.textContent = `WINNER! +$${data.win}`;
        } else {
            messageEl.textContent = "U LOSER";
        }
    })
    .catch(err => {
        messageEl.textContent = "Server Error: " + err;
    });
});
</script>

{% endblock %}